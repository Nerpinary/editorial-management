.PHONY: help install dev build start clean install-all server client

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
	@echo "$(BLUE)–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–æ–π —Ä–µ–¥–∞–∫—Ü–∏–π$(NC)"
	@echo ""
	@echo "$(GREEN)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

install: install-all ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (alias –¥–ª—è install-all)

install-all: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö —á–∞—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
	@echo "$(BLUE)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	@npm install
	@echo "$(GREEN)‚úì –ö–æ—Ä–Ω–µ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(NC)"
	@cd server && npm install
	@echo "$(GREEN)‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(NC)"
	@cd client && npm install
	@echo "$(GREEN)‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(NC)"
	@echo "$(GREEN)üéâ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!$(NC)"

dev: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (—Å–µ—Ä–≤–µ—Ä + –∫–ª–∏–µ–Ω—Ç)
	@echo "$(BLUE)–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...$(NC)"
	@echo "$(YELLOW)Frontend: http://localhost:3000$(NC)"
	@echo "$(YELLOW)Backend:  http://localhost:3001$(NC)"
	@echo "$(YELLOW)–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏$(NC)"
	@echo ""
	@npm run dev

run.dev: dev ## –ê–ª–∏–∞—Å –¥–ª—è dev –∫–æ–º–∞–Ω–¥—ã

build: ## –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
	@echo "$(BLUE)–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞...$(NC)"
	@cd client && npm run build
	@echo "$(GREEN)‚úì –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞$(NC)"

start: build ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–¥–∞–∫—à–µ–Ω –≤–µ—Ä—Å–∏—é
	@echo "$(BLUE)–ó–∞–ø—É—Å–∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä–∞...$(NC)"
	@echo "$(YELLOW)–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:3001$(NC)"
	@cd server && npm start

server: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ backend —Å–µ—Ä–≤–µ—Ä
	@echo "$(BLUE)–ó–∞–ø—É—Å–∫ backend —Å–µ—Ä–≤–µ—Ä–∞...$(NC)"
	@echo "$(YELLOW)API –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:3001$(NC)"
	@cd server && npm run dev

client: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ frontend –∫–ª–∏–µ–Ω—Ç
	@echo "$(BLUE)–ó–∞–ø—É—Å–∫ frontend –∫–ª–∏–µ–Ω—Ç–∞...$(NC)"
	@echo "$(YELLOW)–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:3000$(NC)"
	@cd client && npm run dev

clean: ## –û—á–∏—Å—Ç–∏—Ç—å node_modules –∏ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
	@echo "$(BLUE)–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...$(NC)"
	@rm -rf node_modules
	@rm -rf server/node_modules
	@rm -rf client/node_modules
	@rm -rf client/dist
	@rm -f server/database.sqlite
	@echo "$(GREEN)‚úì –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞$(NC)"
	@echo "$(YELLOW)–ó–∞–ø—É—Å—Ç–∏—Ç–µ 'make install' –¥–ª—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π$(NC)"

reset: clean install ## –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–æ—á–∏—Å—Ç–∫–∞ + —É—Å—Ç–∞–Ω–æ–≤–∫–∞)

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω–æ –≤ —Ñ–æ–Ω–µ)
	@echo "$(BLUE)–õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:$(NC)"
	@tail -f server/logs/app.log 2>/dev/null || echo "$(YELLOW)–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
	@echo "$(BLUE)–°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:$(NC)"
	@lsof -ti:3000,3001 2>/dev/null | while read pid; do \
		echo "$$(ps -p $$pid -o pid,command --no-headers 2>/dev/null)"; \
	done || echo "$(YELLOW)–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã$(NC)"

stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 3000 –∏ 3001
	@echo "$(BLUE)–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...$(NC)"
	@lsof -ti:3000,3001 | xargs kill -9 2>/dev/null || echo "$(YELLOW)–ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã$(NC)"
	@echo "$(GREEN)‚úì –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã$(NC)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
check-deps: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	@echo "$(BLUE)–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:$(NC)"
	@command -v node >/dev/null 2>&1 || { echo "$(RED)‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω$(NC)"; exit 1; }
	@command -v npm >/dev/null 2>&1 || { echo "$(RED)‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω$(NC)"; exit 1; }
	@echo "$(GREEN)‚úì Node.js $(shell node --version)$(NC)"
	@echo "$(GREEN)‚úì npm $(shell npm --version)$(NC)"

# –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
first-run: check-deps install dev ## –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–ø—Ä–æ–≤–µ—Ä–∫–∞ + —É—Å—Ç–∞–Ω–æ–≤–∫–∞ + –∑–∞–ø—É—Å–∫)

# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
setup: first-run ## –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

# –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
backup: ## –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
	@echo "$(BLUE)–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...$(NC)"
	@./backup-db.sh

backup-custom: ## –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–º–µ–Ω–µ–º (NAME=–∏–º—è_—Ñ–∞–π–ª–∞)
	@echo "$(BLUE)–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–º–µ–Ω–µ–º...$(NC)"
	@echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make backup-custom NAME=my_backup"
	@if [ -z "$(NAME)" ]; then \
		echo "$(RED)–û—à–∏–±–∫–∞: —É–∫–∞–∂–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ NAME=–∏–º—è_—Ñ–∞–π–ª–∞$(NC)"; \
		exit 1; \
	fi
	@./backup-db.sh $(NAME)

.DEFAULT_GOAL := help
